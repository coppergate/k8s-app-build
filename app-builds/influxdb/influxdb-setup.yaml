---
apiVersion: v1
kind: Namespace
metadata:
  name: influxdb
  labels:
    pod-security.kubernetes.io/audit: privileged
    pod-security.kubernetes.io/warn: privileged
    pod-security.kubernetes.io/enforce: privileged
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: influxdb-config
  namespace: influxdb
data:
  influxdb.conf: |
    [meta]
      dir = "/var/lib/influxdb/meta"
    
    [data]
      dir = "/var/lib/influxdb/data"
      wal-dir = "/var/lib/influxdb/wal"
      series-id-set-cache-size = 100
    
    [http]
      enabled = true
      bind-address = ":8086"
      auth-enabled = false
      log-enabled = true
---
apiVersion: v1
kind: Secret
metadata:
  name: influxdb-secrets
  namespace: influxdb
type: Opaque
data:
  # Default admin credentials - these values are base64 encoded
  # Change these in production!
  admin-username: YWRtaW4=  # "admin"
  admin-password: cGFzc3dvcmQ=  # "password"
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: influxdb-data
  namespace: influxdb
spec:
  accessModes:
    - ReadWriteMany
  storageClassName: rook-ceph-fs-sc
  resources:
    requests:
      storage: 50Gi
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: influxdb
  namespace: influxdb
spec:
  replicas: 1
  selector:
    matchLabels:
      app: influxdb
  template:
    metadata:
      labels:
        app: influxdb
    spec:
      containers:
        - name: influxdb
          image: quay.io/influxdb/influxdb3-core
          ports:
            - containerPort: 8086
              name: http
          env:
            - name: DOCKER_INFLUXDB_INIT_MODE
              value: "setup"
            - name: DOCKER_INFLUXDB_INIT_USERNAME
              valueFrom:
                secretKeyRef:
                  name: influxdb-secrets
                  key: admin-username
            - name: DOCKER_INFLUXDB_INIT_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: influxdb-secrets
                  key: admin-password
            - name: INFLUXDB3_WRITER_IDENTIFIER_PREFIX
              value: influxdb-local
            - name: DOCKER_INFLUXDB_INIT_ORG
              value: "k8s-local"
            - name: DOCKER_INFLUXDB_INIT_BUCKET
              value: "mybucket"
            - name: DOCKER_INFLUXDB_INIT_ADMIN_TOKEN
              value: "my-super-secret-auth-token"
          volumeMounts:
            - name: influxdb-data
              mountPath: /var/lib/influxdb2
            - name: influxdb-config
              mountPath: /etc/influxdb
          resources:
            requests:
              cpu: 500m
              memory: 512Mi
            limits:
              cpu: 2
              memory: 2Gi
          livenessProbe:
            httpGet:
              path: /health
              port: 8086
            initialDelaySeconds: 30
            timeoutSeconds: 5
          readinessProbe:
            httpGet:
              path: /health
              port: 8086
            initialDelaySeconds: 5
            timeoutSeconds: 3
      volumes:
        - name: influxdb-data
          persistentVolumeClaim:
            claimName: influxdb-data
        - name: influxdb-config
          configMap:
            name: influxdb-config
---
# kubectl expose deployment influxdb --name=influxdb --port=8086 --target-port=8086 --type=LoadBalancer -n influxdb

helm repo add influxdata https://helm.influxdata.com/
helm repo update
helm pull influxdata/influxdb3-clustered --version X.Y.Z

helm install influxdb influxdata/influxdb3-clustered \
-f values.yaml \
--namespace influxdb \
--create-namespace
